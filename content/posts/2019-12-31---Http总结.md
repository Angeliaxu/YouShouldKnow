---
title: HTTP知识总结
date: "2019-12-31"
template: "post"
draft: false
slug: "/post/httpSummarized/"
category: "Http"
tags: 
    - "Http"
description: "一个http操作称为一个事务：一个事分成几个步骤，步骤之间串行操作，只要前面任何一个步骤出了问题，这件事就算失败，回滚是事务当中的一部分。"
socialImage: "/media/42-line-bible.jpg"
---

### http发展历史 ###
http/0.9 -> http/1.0 -> http/1.1 -> http/2.0。目前大部分使用http协议的都是以http/1.1版本为基础。
### http工作过程 ###
一个http操作称为一个事务：一个事分成几个步骤，步骤之间串行操作，只要前面任何一个步骤出了问题，这件事就算失败，回滚是事务当中的一部分。
* 首先客户机与服务器需要建立连接
* 建立连接后，发送请求报文
* 服务器接到请求后，给与响应信息
* 客户端接收服务器返回进行显示，然后与服务器断开连接

### http所处位置 ###
TCP/IP协议栈 之 TCP/IP：事实协议
* 应用层：http、ftp、dns、smtp、ssh，为用户提供所需要的各种服务
* 传输层：tcp、udp在此层，tcp稳定可靠，保证数据送达，没送达也会让你知道；udp不可靠，只负责发，至于送到没有，不管，但是可以使用顶层设计来保证udp可靠，http3传输层使用的是udp，并且进行顶层设计，为应用层实体提供端到端的通信功能，保证数据包的顺序传送以及数据的完整性。
* 网络层：ip协议在此层，主要解决主机到主机的通信功能，ip协议是网际互联层最重要的协议。
* 数据链路层：在通信的实体之间建立数据链路链接
* 物理层：主要定义物理设备如何传输数据（网线，网卡，光纤等。

TCP/IP协议栈 之 ISO/OSI：标准协议，理想状态，现实当中并不是这样实现的。
* 应用层
* 表示层
* 会话层
* 传输层
* 网络层
* 数据链路层
* 物理层

### http请求方法 ###

* get：请求获取request--URI所标识的资源
* post：在request--URI所标识的资源后附加新的数据
* head：请求获取由request--URI所标识的资源的响应消息报头  
* put：请求服务器存储一个资源，并用request--URI作为其标识
* delete：请求服务器删除request--URI所标识的资源
* trace：请求服务器讲之前的请求通信返回给客户端
* connnect：要求在与代理服务器通信试建立隧道，实现用隧道协议进行tcp通信
* options：请求查询服务器性能，或者查询与资源相关的选项和需求

### http状态码 ###
* 1XX：指示信息--表示请求已接收处理（异步处理需要很长时间，返回1开头的状态码）
* 2XX：成功，表示请求已经被成功接收
* 3XX：重定向，要完成请求必须进行更进一步的操作
* 4XX：客户端错误，请求有语法错误或请求无法时间
* 5XX：服务端错误，服务器未能实现合法的请求

### http存在的缺点 ###
* 通信使用明文（不加密），内容可能会被窃听：不管是加密还是未加密的的内容，都有可能会被窃听，只能说如果通信进过加密，就有可能让人无法破解报文的信息。   
**解决办法：加密处理防止被窃听**  
* 不验证通信方的的身份，因此有可能遭遇伪装：服务器或者客户端都没有办法确认对方是不是自己想要连接的对象，有可能是伪装的服务器，有可能是伪装的客户端。无法判定请求是来自何方，出自谁手。   
**解决办法：购买证书，证书由值得信任的第三方机构颁发，用以证明服务器和客户端是实际存在的。并且伪造证书是一件异常困难的事儿。**
* 无法证明报文的完整性，所以有可能已遭篡改：数据在请求或者响应过程当中，遭攻击者拦截并篡改内容，没有办法确认，发出的请求/响应和接收到的请求/响应是前后相同的。   
**解决办法：常用的是MD5和SHA-1等散列值校验方法，以及用来确认文件的数字签名方法。不管使用哪一种方法，需要操纵客户端的用户本人亲自检查验证下载的文件是否就是原来服务器上的文件，浏览器无法自动帮用户检查。所以这个方法也不是百分之百的可行。如果散列值被改写的话，用户是没有办法意识到的。**

### Https ###
http+加密+认证+完整性保护 = https  

https不是应用层的的新协议，只是http通信接口部分用ssl和tls协议代替，一般http都是直接和tcp通信，当使用ssl时，演变成先和ssl通信，再和tcp通信。   
核心：客户端与服务端使用对称加密算法，使用秘钥加密之后，需要告知另外一方秘钥，并且通过秘钥解密。秘钥的交换还需要使用非对称加密来完成。这里不禁产生一个疑问，**既然可以使用非对称加密来对秘钥进行加密交换，为什么不直接使用非对称加密来直接进行加密通信呢？**是因为非对称加密效率比对称加密效率要慢，并且消耗的资源比对称加密要多。另外一方面，非对称加密是单向的，客户端与服务器之间的交流是双向的。  

到这里，解决了http是明文传输的缺点。接下来解决怎么认证客户端与服务端是想要连接的彼此无法让中间人进行攻击。需要使用到第三方的CA证书了。CA：数字证书的权威签发机构，审核申请者身份后签发数字证书，这样只需要校验数字证书即可确定对方的真实身份。  

CA证书的工作流程：   
* 服务器example.com有一对自己的非对称加密秘钥对，服务器保存秘钥，把公钥交给CA请求证书。
* 第三方机构为服务器创建证书，证书包含必要的数据，服务器名称，服务器公钥，证书的hash值，并且使用自己的私钥对hash进行加密。
* 客户端内置的有第三方机构的公钥，取到服务器发送的证书，使用公钥验证证书的数字签名，确认服务器公钥的真实性
* 客户端使用服务器公钥进行加密处理发送给服务端


### Https握手步骤 ###   
 1. 客户端发送支持的ssl版本协议，加密组件（cipher suit）列表（所使用的加密算法以及秘钥长度等）
 2. 服务器响应，根据客户端发送的加密组件列表筛选出来支持的ssl协议版本以及加密组件
 3. 服务器发送ca证书
 4. 服务器通知客户端最初的ssl握手协议结束
 5. 客户端使用公钥加密一种随机密码串（pre-master secret）进行发送
 6. 接着发送chang cipher spec报文，告诉服务器以pre-master secret进行加密通信
 7. 客户端发送finished报文，此次握手否成功，以服务器是都能够正确解析该报文作为判定标准
 8. 服务器统同样发送change cipher spec报文
 9. 服务器发送finished报文
 10. ssl建立连接完成，通信收到ssl保护
 11. 发送http
 12. 客户端断开连接

![sslconnect.png](/media/sslconnect.png)

### ssl存在的问题 ###
当使用ssl，处理速度会变慢。和http通信相比，ssl通信部分消耗网络资源。而ssl通信部分，又因为要对通信进行处理，所以时间上延长了。另一方面，客户端和服务器还要做加解密处理，会消耗cpu和内存等硬件资源，导致处理速度变慢。使用ssl加速器，可以改善速度变慢的问题。

### http2协议分析 ###
相对于http/1.1升级了一些底层的机制，优化了数据的格式化规则，多路复用，底层依赖靠数据帧（二进制)，不兼容http/1.1。   
![http2.png.png](/media/http2.png)
特点   
* 对报头压缩，降低开销
* 使用二进制格传输，更高效紧凑   
http/1.1协议以换行符作为纯文本的分隔符，而http/2.0将所有传输的信息分割为更小的消息和帧，并采用二进制格式对他们编码，客户端和服务器会替我们完成必要的分帧工作
![http2-data.png](/media/http2-data.png)
* 多路复用，一个tcp连接实现并行请求   
并行交错的发送多个请求，请求之间互不影响；并行交错的发送多个响应，响应之间互不干扰；使用一个连接并行发送多个请求和响应，消除不必要的延迟和提高现有网络容量的利用率，从而减少页面加载时间
![http2-transition.png](/media/http2-transition.png)
* 伪头字段   
以:开头的头字段，用来代替http/1.1中信息(:method、:scheme、:authority、:path、:status)
![http2-header](/media/http2-header.png)
* 服务器主动推送，解决队首阻塞问题（页面骨架请求完成才来请求资源）
* 默认使用加密（可以选择关闭）

### http3协议了解 ###
运行在QUIC之上的HTTP协议被称为http3（http over quic），quic 协议（quick UDP ineternet connection）基于UDP，正是看中了UDP的速度与效率，同时也整合了TCP，TLS和http2 的优点，并加以优化。
![http3](/media/http3.png)

### 代理 ###
1. 正向代理：在一个局域网内办公室或者家，多个客户端，代理服务器放在出口，客户端想要访问外网，出口需要限制，就加一个服务器，限制访问权限，监控访问记录，缓存节约出口带宽。在网络上带宽资源非常宝贵。
2. 反向代理：局域网是机房，机房只有一个入口，机房里有多个服务器，多个服务器域名不同但是共享一个ip。
    * 加密和SSL加速
    * 负载均衡，提供配置灵活的转发功能，根据不同的正则匹配，采取不同的转发策略。高速缓存里面放的是静态资源，设计到数据需要从服务器读取
    ![proxy](/media/proxy.png)
    * 缓存静态内容
    * 压缩
    * 减速上传（百度网盘限制你上传文件就是使用了反向代理）
    * 安全（攻击服务器必须先攻破反向代理服务器，可以作为一个堡垒机，防火墙）
    * 外网发布
![proxy2](/media/proxy2.png)
